<!DOCTYPE html>
<html lang="ko">
<style>
body {
    margin: 0;
    padding: 0;
    
}

.bookcover {
    width: 80%;
    margin: auto;
    padding: 20px;
}


.profile-container, .content-container, .menu-container {
    display: flex;
    flex-direction: column;
    margin: 10px 0;
}

.profile-title, .content-title {
    margin: 10px 0px;
    font-size: 1.2em;
}


.profile-box, .content-box {
    border: 1px solid #ddd;
    padding: 10px;
    border-radius: 8px;
}

.profile-image-img {
    width: 200px;
    height: 200px;
    border-radius: 50%;
}

.profile-text, .profile-username, .profile-dropdown {
    margin: 10px 0;
}

.dropdown-button {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
}

.dropdown-title {
    font-size: 1em;
}

.triangle-down {
    width: 0;
    height: 0;
    border-left: 5px solid transparent;
    border-right: 5px solid transparent;
    border-top: 5px solid black;
    margin-left: 10px;
}

.guestbook-scrollbox {
    max-height: 450px;
    overflow-y: auto;
}

.guestbook-box {
    border-bottom: 1px solid #ddd;
    padding: 10px 0;
}

.guestbook-title {
    font-weight: bold;
    margin-bottom: 5px;
}

.guestbook-contents {
    padding-left: 10px;
}

.guestbook-text {
    margin: 0;
}

.guestbook-writer {
    display: flex;
    align-items: center;
    margin-top: 10px;
}

#guestbookInput {
    flex: 1;
    padding: 0px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-right: 10px;
    height: 60px;
    margin-top: 10px;
}

.guestbook-button {
    padding: 10px 20px;
    background-color: #3b87ab;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    height: 55px;
}

.menu-button {
    display: flex;
    flex-direction: column;
}

.menu-button a {
    text-decoration: none;
    margin: 5px 0;
}
.guest-text{
    border-bottom: 1px solid #000;
}
.material-icons{
    cursor: pointer;
    border: none;
    background-color: transparent;
}
.guest-check-box{
    padding: 0px 10px;
}
.btn-primary{
    background-color: #3b87ab;
    cursor: pointer;
    border-radius: 4px;
    float: right;
    margin-right: 15px;
    color: #fff;
    border: none;
    width: 43px;
    height: 25px;
}
.btn-secondary{
    background-color: #3b87ab;
    cursor: pointer;
    border-radius: 4px;
    float: right;
    color: #fff;
    border: none;
    width: 43px;
    height: 25px;
}
.guest-text{
    font-size: 20px;
}
.edit-textarea {
    width: 100%;
    height: auto;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-sizing: border-box;
}


</style>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>guestbookList</title>
    <link rel="stylesheet" href="/css/font.css">
    <link rel="stylesheet" href="/css/minihomepage.css">
    <link rel="stylesheet" href="/css/layout.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
</head>
<body>
<th:block th:include="common/top"></th:block>
                                <div class="guestbook-scrollbox" id="guestbook-scrollbox">
                                    <div class="guest-text">방명록 ></div>
                                    <th:block th:each="guestbookList : ${guestbookList}">
                                    <div class="guestbook-box">
                                        <div class="guestbook-title">
                                        	NO.<span id = "guestCommentNo" th:text="${guestbookList.guestCommentNo}"></span>
                                            <span th:text="${guestbookList.guestNickname}"></span>
                                            <span th:text="${guestbookList.guestCommentDate}"></span>
                                           <button class="material-icons" onclick="navigateToHome(this)" data-url="#" th:data-url="'/guest/home?guestCommentNo=' + ${guestbookList.guestCommentNo}">home</button>
                                            <div class="guestbook-date">
                                                <button class="btn-secondary" onclick="confirmDeleteComment(this)">삭제</button>
                                                <button class="btn-primary" onclick="editComment(this)">수정</button>
                                            </div>
                                        </div>
                                        <div class="guestbook-contents">
                                            <div class="guestbook-text">
                                                <span id = "guestCommentContent" th:text="${guestbookList.guestCommentContent}"/>
                                                <textarea id ="edit-textarea" class="edit-textarea" style="display: none;"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                    </th:block>
                                </div>
                            <form action="/guest/insertComment" method="post">
	                            <div class="guest-check-box">
	                                <input type="radio" name="guestBookType" id="anonymous" value="0">
	                                <label for="anonymous">익명</label>
	                                <input type="radio" name="guestBookType" id="nickname" value="1">
	                                <label for="nickname">닉네임</label>
	                            </div>
	                            <div class="guestbook-writer">
									                          
	                                <textarea id="guestbookInput" name="guestbookInput" placeholder="방명록을 입력해주세요."></textarea>
	                               <input type="hidden" id = "guestNickname" name="guestNickname" th:value="${session.member.memberNickName}">	                               	
	                               <input type="hidden" id = "memberNo" name="memberNo" th:value="${session.member.memberNo}">
	                               <input type="hidden" id = "guestWriterNo" name="guestWriterNo" th:value="${session.member.memberNo}">
	                                <button type="guestbook-button" onclick="addGuestbookEntry()">전송</button>

	                            </div>
                            </form>
                        <th:block th:include="common/bottom"></th:block>
    <script>

    getNickName();
    function getNickName(){
    	const memberNickNameValue = $(".profile-username>span").text();
    	$(".nickName").val(memberNickNameValue);
    }
   
    
  //댓글추가
    function addGuestbookEntry() {
        const input = document.getElementById('guestbookInput');
        const text = input.value.trim();
        const identity = document.querySelector('input[name="guestBookType"]:checked');
        const guestBookType = identity ? identity.value : null;
        const memberNo = $("#memberNo").val();
        const error = "/guest/guestbookList";
        if (text === '') {
            alert('댓글 내용을 입력하세요.');
            return;
        }

        if (!guestBookType) {
            alert('익명 또는 닉네임을 선택하세요.');
            return error;
        }
        

  }
	//댓글 리스트
 function addCommentToList(comment) {
	    const guestBook = {
	        guestCommentNo: comment.guestCommentNo,
	        guestWriterNo: comment.guestWriterNo,
	        guestCommentContent: comment.guestCommentContent,
	        guestCommentDate: comment.guestCommentDate,
	        memberNo: comment.memberNo,
	        guestBookType: comment.guestBookType
	    };
	 const commentHtml = `
		    <div class="guestbook-box" data-comment-no="${guestBook.guestCommentNo}">
		        <div class="guestbook-title">No. ${guestBook.guestCommentNo}
		            <span>${guestBook.guestWriterNo}</span>
		            <button class="material-icons" onclick="goToHomePage(this)">home</button>
		            <div class="guestbook-date">${guestBook.guestCommentDate}
		                <button class="btn-secondary" onclick="confirmDeleteComment(this)">삭제</button>
		                <button class="btn-primary" onclick="editComment(this)">수정</button>
		            </div>
		        </div>
		        <div class="guestbook-contents">
		            <div class="guestbook-text">
		                <p>${guestBook.guestCommentContent}</p>
		                <textarea class="edit-textarea" style="display: none;"></textarea>
		            </div>
		        </div>
		    </div>
		`;
     $('#guestbook-scrollbox').prepend(commentHtml);
 }

//댓글 삭제 확인
 function confirmDeleteComment(button) {
     const guestbookBox = button.closest('.guestbook-box');
     const guestCommentNo = document.getElementById('guestCommentNo'); 
     console.log(guestCommentNo);

     if (!guestCommentNo) {
         console.error('댓글 번호가 없습니다.');
         return;
     }

     if (confirm('정말로 이 댓글을 삭제하시겠습니까?')) {
         deleteComment(button);
     }
 }
 
// 댓글 삭제
 function deleteComment(button) {
     const guestbookBox = button.closest('.guestbook-box');
     const guestCommentNo = $('#guestCommentNo').text();

     if (!guestCommentNo) {
         console.error('댓글 번호가 없습니다.');
         return;
     }

     $.ajax({
         type: 'GET',
         url: `/guest/deleteComment`,
         data: {guestCommentNo: guestCommentNo},
         success: function(response) {
             guestbookBox.remove();
         },
         error: function(error) {
             alert('댓글 삭제 중 오류가 발생했습니다.');
         }
     });
 }

 // 댓글 수정
 function editComment(button) {
     const guestbookBox = button.closest('.guestbook-box');
     const textElement = guestbookBox.querySelector('.guestbook-text span');
     const textarea =  document.getElementById("edit-textarea").value;
	 console.log("textarea");
	 
     if ($('#edit-textarea').css('display') === 'none') {
         textarea.value = document.getElementById("edit-textarea").value;
         $('#edit-textarea').css('display', 'block');         
         button.textContent = '저장';
         button.setAttribute('onclick', 'saveComment(this)');
     }
 }
    // 댓글 저장
    function saveComment(button) {
        const guestbookBox = button.closest('.guestbook-box');
        const textarea = document.getElementById("edit-textarea").value;
        const textElement = guestbookBox.querySelector('.guestbook-text p');
        const newText = document.getElementById("edit-textarea").value;
        const guestCommentNo = $('#guestCommentNo').text();
        
        
        console.log(guestbookBox);
        console.log(textarea);
        console.log(textElement);
        console.log(newText);
        console.log(guestCommentNo);

        if (newText === '') {
            alert('댓글 내용이 비어있습니다.');
            return;
        }


        if (!guestCommentNo) {
            console.error('댓글 번호가 없습니다.');
            return;
        }



        $.ajax({
            type: 'POST',
            url: '/guest/updateComment',
            data : JSON.stringify ({
            	guestCommentNo : guestCommentNo,
            	guestCommentContent : newText
            }),
            contentType: 'application/json',
            success: function(response) {
            	
            },
            error: function(error) {
                alert('댓글 수정 중 오류가 발생했습니다.');
            }
        });
    }
 // 홈 버튼 클릭 시 호출되는 함수
    function navigateToHome(button) {
        const guestCommentNo = $(button).closest('.guestbook-box').find('#guestCommentNo').text();
        const url = $(button).attr('data-url');

        if (!url || url === '#') {
            alert('익명의 사용자로 접근 불가');
            history.back(); // 이전 페이지로 돌아가기
            return;
        }

        // 닉네임 사용자의 경우 URL로 이동
        window.location.href = "/member/minihomepage";
    }
    
    $(document).ready(function() {
        document.getElementById('guestbookInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                addGuestbookEntry();
            }
        });
    });

    </script>
    <th:block th:include="common/bottom"></th:block>
</body>
</html>